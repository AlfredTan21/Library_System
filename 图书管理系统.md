# 图书管理系统

## 项目背景

### 用户角色

1）读者：

1. 教师：一次能借20本书，能借60天
2. 职工：一次能借15本书，能借60天
3. 学生：一次能借10本书，能借30天

2）管理员：图书馆工作人员，负责办理图书借阅归还等业务。

### 核心业务

1）图书借阅：读者到图书馆借书

2）图书归还：读者到图书馆还书

3）超期罚款：借书超期未还要罚款，并记入个人违规记录

4）图书丢失：读者丢失图书，要赔钱，并记入个人违规记录。(以上业务都要由管理员经办)



## 数据表设计

**（1）** ***关系模式转化***：根据6种转化方法（强实体集转化、弱实体集转化、联系集转化、复合属性及多值属性转化、类层次转化、聚合转化），将E-R图转化为关系模式。（根据需要，可以定义新的实体）。

读者信息（<u>读者编号</u>，姓名，性别，登记日期，有效期至，现借图书数数，累计借图书数，状态，备注，读者类别，可借次数，可借天数）

读者联系电话（<u>读者编号</u>，联系电话）

读者违约记录（<u>读者编号</u>，违约记录）

图书信息（<u>ISBN</u>，书名，作者，简介，库存总量，现在库数量）

图书出版社信息（<u>ISBN</u>，出版社）

图书版次日期信息（<u>ISBN</u>，版次，出版日期）

图书价格信息（<u>ISBN</u>,价格）

管理员信息（<u>管理员工号</u>，姓名，性别，岗位，联系电话）

违约数据（<u>违约类型</u>，违约金额）

图书借阅（<u>读者编号，ISBN，管理员工号</u>，借阅时间，应还时间，续借次数）

图书归还（<u>读者编号，ISBN，管理员工号</u>，归还时间，是否超期）

丢失罚款（<u>读者编号，ISBN，管理员工号，系统更新时间</u>，是否交款，违约时间，违约类型，备注）

超期罚款（<u>读者编号，ISBN，管理员工号，系统更新时间</u>，是否交款，违约时间，违约类型，备注）

**（1）** ***关系模式优化***：依次考虑第一范式、第二范式、第三范式。

根据第三范式，将**读者信息优化为读者类别信息+读者信息：**

读者信息（<u>读者编号</u>，姓名，性别，登记日期，有效期至，现借图书数数，累计借图书数，状态，备注，读者类别编号）

外键：读者类别编号

读者类别（<u>读者类别编号</u>，读者类别名称，可借次数，可借天数）

将**图书出版社信息优化为图书出版社信息+出版社基本信息：**

图书出版社信息（<u>ISBN</u>，出版社编号）

外键：出版社编号

出版社基本信息（<u>出版社编号</u>，出版社名称，联系人，联系电话，传真，地址）

将**图书信息优化为图书基本信息+图书馆藏信息：**

图书基本信息（<u>ISBN</u>，书名，作者，简介）

图书馆藏信息（<u>图书馆藏编号</u>，ISBN，状态，入库时间）

外键：ISBN

修改图书借阅与图书归还、罚款：

图书借阅（<u>读者编号，图书馆藏编号，管理员工号</u>，借阅时间，应还时间，续借次数）

图书归还（<u>读者编号，图书馆藏编号，管理员工号</u>，归还时间，是否超期）

丢失罚款（<u>读者编号，图书馆藏编号，管理员工号，系统更新时间</u>，是否交款，违约时间，违约类型，备注）

超期罚款（<u>读者编号，图书馆藏编号，管理员工号，系统更新时间</u>，是否交款，违约时间，违约类型，备注）

**注：**只有int类型可以自增，为了使主键自增长，主键均设为int类型。但是编号一般都会比较长，设置成int类型占用内存，所以以下所有的编号都设了一个排序编号作为主键

### 读者信息（reader_info)

| 字段名         | 类型        | 备注                     | key  |
| -------------- | ----------- | ------------------------ | ---- |
| RRID           | int         | 读者排序编号             | 主键 |
| RID            | varchar(10) | 读者编号                 |      |
| RTID           | int         | 读者类型编号             | 外键 |
| RName          | varchar(30) | 读者姓名                 |      |
| sex            | int         | 性别                     |      |
| tel            | varchar(11) | 电话                     |      |
| register_date  | date        | 注册日期                 |      |
| efficency_date | date        | 有效期                   |      |
| tmp_borrow_num | int         | 现借数量                 |      |
| acc_borrow_num | int         | 已借数量                 |      |
| volate_num     | int         | 违规次数                 |      |
| state          | int         | 状态（0--正常，1--违规） |      |
| remark         | text        | 备注                     |      |

### 读者类别信息(reader_type)

| 字段名       | 类型        | 备注         | key  |
| ------------ | ----------- | ------------ | ---- |
| RTID         | int         | 读者类别编号 | 主键 |
| RTName       | varchar(30) | 读者类别     |      |
| borrow_limit | int         | 可借次数     |      |
| day_limit    | int         | 可借天数     |      |

### 管理员信息(manager_info)

| 字段名   | 类型        | 备注           | key  |
| -------- | ----------- | -------------- | ---- |
| MRID     | int         | 管理员排序编号 | 主键 |
| MID      | varchar(10) | 管理员编号     |      |
| MName    | varchar(30) | 管理员姓名     |      |
| sex      | int         | 性别           |      |
| tel      | varchar(11) | 电话           |      |
| post     | varchar(30) | 传真           |      |
| UserName | varchar(30) | 用户名         |      |
| Password | varchar(30) | 密码           |      |

### 图书基本信息(book_info)

| 字段名         | 类型        | 备注         | key  |
| -------------- | ----------- | ------------ | ---- |
| BRID           | int         | 图书排序编号 | 主键 |
| ISBN           | varchar(20) | ISBN编号     |      |
| BName          | varchar(30) | 图书名       |      |
| author         | varchar(30) | 作者         |      |
| abstract       | text        | 摘要         |      |
| total_amount   | int         | 库存总量     |      |
| current_amount | int         | 在库数量     |      |

### 图书价格信息(book_price_info)

同一本书可能有多种价格，所以要分一个表（多值属性转化）

| 字段名 | 字段类型 | 备注         | key  |
| ------ | -------- | ------------ | ---- |
| BRID   | int      | 图书排序编号 | 主键 |
| price  | int      | 价格         |      |

### 图书出版社信息(book_edit_info)

同一本书可能有多个出版社，所以也要分一个表

同时为了满足第三范式（消除传递依赖），要把出版社信息单独写在一个表里

| 字段名 | 类型 | 备注         | key  |
| ------ | ---- | ------------ | ---- |
| BRID   | int  | 图书排序编号 | 主键 |
| PHID   | int  | 出版社编号   | 主键 |

### 出版社信息(edit_house_info)

| 字段名   | 类型        | 备注       | key  |
| -------- | ----------- | ---------- | ---- |
| PHID     | int         | 出版社编号 | 主键 |
| EName    | varchar(30) | 出版社名称 |      |
| contacts | varchar(30) | 联系人     |      |
| tel      | varchar(11) | 联系电话   |      |
| email    | varchar(30) | 邮箱       |      |
| address  | text        | 地址       |      |

### 图书出版日期信息(book_edit_info)

同样是因为同一本书也可能有好几个出版日期

| 字段名    | 类型 | 备注         | key  |
| --------- | ---- | ------------ | ---- |
| BRID      | int  | 图书排序编号 | 主键 |
| edit_ID   | int  | 版次         |      |
| edit_date | date | 出版日期     |      |

### 图书馆藏信息(book_store_info)

| 字段名           | 类型        | 备注                   | key  |
| ---------------- | ----------- | ---------------------- | ---- |
| SRID             | int         | 馆藏排序编号           | 主键 |
| SID              | varchar(10) | 馆藏编号               |      |
| BRID             | int         | 图书排序编号           | 外键 |
| state            | int         | 状态(在库，借出，丢失) |      |
| warehousing_date | date        | 入库时间               |      |

### 图书借阅信息(book_borrow_info)

| 字段名         | 类型 | 备注           | key  |
| -------------- | ---- | -------------- | ---- |
| RRID           | int  | 读者排序编号   | 主键 |
| MRID           | int  | 管理员排序编号 | 主键 |
| SRID           | int  | 馆藏排序编号   | 主键 |
| borrow_time    | date | 借阅时间       |      |
| repayment_time | date | 应还时间       |      |
| renew_num      | int  | 续借次数       |      |

### 图书归还信息(book_return)

| 字段名      | 类型 | 备注                             | key  |
| ----------- | ---- | -------------------------------- | ---- |
| MRID        | int  | 管理员排序编号                   | 主键 |
| SRID        | int  | 馆藏排序编号                     | 主键 |
| RRID        | int  | 读者排序编号                     | 主键 |
| return_time | date | 归还时间                         |      |
| overdue     | int  | 是否超期（0--未超期，1--已超期） |      |

### 罚款信息(fine)

| 字段名        | 类型 | 备注           | key  |
| ------------- | ---- | -------------- | ---- |
| MRID          | int  | 管理员排序编号 | 主键 |
| SRID          | int  | 馆藏排序编号   | 主键 |
| RRID          | int  | 读者排序编号   | 主键 |
| default_type  | int  | 违规类型       |      |
| pay           | int  | 是否交款       |      |
| defaulty_time | date | 违规时间       |      |
| fine_num      | int  | 罚款金额       |      |



## 存储过程

### addBook

新建图书的时候会批量添加相应的馆藏信息

```sql
-- 用来添加图书基本信息
CREATE PROCEDURE addBook
(IN isbn_ VARCHAR(4),IN bname_ VARCHAR(10),IN author_ VARCHAR(10),IN ename_ VARCHAR(30),IN editid_ VARCHAR(30),IN etime_ DATE,IN totalnum_ INT,IN currnum_ INT,IN price_ INT,IN abstract_ TEXT)
BEGIN
	DECLARE phid_ INT;
	DECLARE brid_ INT;
	DECLARE cnt INT;
	DECLARE sid_ VARCHAR(10);
	SELECT PHID FROM edit_house_info WHERE EName=ename_ LIMIT 1 INTO phid_;
	INSERT INTO book_info VALUES(isbn_,bname_,author_,abstract_,totalnum_,currnum_);
	SELECT BRID FROM book_info WHERE ISBN=isbn_ LIMIT 1 INTO brid_;
	INSERT INTO book_edit_info VALUES(brid_,phid_);
	INSERT INTO book_date_info VALUES(brid_,editid_,etime_);
	INSERT INTO book_price_info VALUES(brid_,price);
	SET cnt=totalnum_;
	loop_label: LOOP -- 循环创建馆藏信息
		SELECT createSID(brid_) into sid_;-- 这里在用自定义函数创建馆藏编号
		INSERT INTO book_store_info VALUES(null,sid_,brid_,"在库",etime_);
		SET cnt=cnt-1;
		IF cnt=0 THEN
			LEAVE loop_label; 
		END IF; 
	END LOOP;
END;
```

### addReader

为了保证防止中途抛出异常导致多表变更不同步，所有多表变更都要开启事务

这里是单表好像是不用开启事务的，应该是我中途删了什么表但是忘了把事务删了

```sql
-- 用来添加读者基本信息
CREATE PROCEDURE addReader
(IN rname_ VARCHAR(30),IN rtid_ INT,IN sex INT,IN currbor_ INT,IN totalbor_ INT,IN tel_ VARCHAR(11),IN effi_ date,IN state_ INT,IN violatenum_ INT,IN remark_ text,OUT result INT)
BEGIN
	DECLARE rid_ VARCHAR(10);
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE; -- 判断是否发生异常
	SET @@autocommit=0; -- 关闭自动提交
	START TRANSACTION; -- 开启事务
	SELECT max(RID) FROM reader_info INTO rid_;
	if rid_ IS NULL THEN
		SET rid_="2130001"; -- 读者编号从2130001开始排
	ELSE
		SET rid_=rid_+1;
	END IF;
	INSERT INTO reader_info VALUES(NULL,rid_,rtid_,rname_,sex_,tel_,NOW(),effi_,currbor_totalbor_,violatenum_,state_,remark_);
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END;
```

### addStore

添加单个馆藏信息

```sql
-- 用来添加馆藏信息
CREATE PROCEDURE addStore
(IN isbn_ VARCHAR(20),IN state_ INT,IN whtime_ DATE,OUT result INT)
BEGIN
	DECLARE sid_ VARCHAR(10);
	DECLARE brid_ INT;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE;
	SET @@autocommit=0;
	START TRANSACTION;
	SELECT BRID FROM book_info WHERE ISBN=isbn_ INTO brid_;
	SELECT createSID(brid_) INTO sid_;
	INSERT INTO book_store_info VALUES(NULL,sid_,state_,whtime_);
	IF state=0 THEN
		UPDATE book_info SET total_amount=total_amount+1; -- 不在库，只用更新库存总量
	ELSE
		-- 在库，更新库存总量和在库数量
		UPDATE book_info SET total_amount=total_amount+1,current_amount=current_amount+1;
	END IF;
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END;
```

### borrowBook

```sql
-- 用来进行图书借阅
CREATE PROCEDURE borrowBook
(IN brid_ INT,IN rid_ VARCHAR(10),IN mid_ VARCHAR(10),OUT result INT)
BEGIN
	DECLARE srid_ INT;
	DECLARE rrid_ INT;
	DECLARE mrid_ INT;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE;
	SET @@autocommit=0;
	START TRANSACTION;
	UPDATE book_info SET current_amount=current_amount-1 WHERE BRID=brid_;
	SELECT SRID FROM book_store_info WHERE BRID=brid_ AND state=1 LIMIT 1 INTO srid_;
	UPDATE book_store_info SET state=0 WHERE SRID=srid_;
	SELECT RRID FROM reader_info WHERE RID=rid_ INTO rrid_;
	SELECT MRID FROM manager_info WHERE MID=mid_ INTO mrid_;
	UPDATE reader_info SET tmp_borrow_num=tmp_borrow_num+1,acc_borrow_num=acc_borrow_num+1 WHERE RID=rid_;
	INSERT INTO book_return VALUE(mmid_,srid_,rrid_,NULL,0);
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END;
```

### deleteBook

```sql
-- 用来删除图书基本信息
CREATE PROCEDURE deleteBook
(IN brid_ INT,OUT result INT)
BEGIN
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE;
	SET @@autocommit=0;
	START TRANSACTION;
	DELETE FROM book_store_info WHERE BRID=brid_;
	DELETE FROM book_edit_info WHERE BRID=brid;
	DELETE FROM book_date_info WHERE BRID=brid_;
	DELETE FROM book_price_info WHERE BRID=brid_;
	DELETE FROM book_info WHERE BRID=brid_;
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END;
```

### deleteStore

```sql
-- 用来删除馆藏信息
CREATE PROCEDURE deleteStore
(IN srid_ INT,IN state_ INT,OUT result INT)
BEGIN
	DECLARE brid_ INT;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE;
	SET @@autocommit=0;
	START TRANSACTION;
	SELECT BRID FROM book_store_info WHERE SRID=srid_ INTO brid_;
	DELETE FROM book_store_info WHERE SRID=srid_;
	IF state_=0 THEN
		UPDATE book_info SET total_amount=total_amount-1 WHERE BRID=brid_;
	ELSE
		UPDATE book_info SET total_amount=total_amount-1,current_amount=current_amount-1 WHERE BRID=brid_;
	END IF;
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END;
```

### payFine

```sql
-- 用来更新缴费信息
CREATE PROCEDURE payFine(IN rid_ VARCHAR(10),IN sid_ VARCHAR(10),IN mid_ VARCHAR(10),IN defaultType_ INT,OUT result INT)
BEGIN
	DECLARE srid_ INT;
	DECLARE rrid_ INT;
	DECLARE mrid_ INT;
	DECLARE price_ INT;
	DECLARE repayment_ date;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE;
	SET @@autocommit=0;
	START TRANSACTION;
	SELECT RRID FROM reader_info WHERE RID=rid_ INTO rrid_;
	SELECT SRID FROM book_store_info WHERE SID=sid_ INTO srid_;
	SELECT MRID FROM manager_info WHERE MID=mid_ INTO mrid_;
	UPDATE fine SET MRID=mrid_,pay=1 WHERE SRID=srid_ AND RRID=rrid_;
	UPDATE reader_info SET state=0 WHERE RRID=rrid_;
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END
```

### renewBook

```sql
CREATE PROCEDURE renewBook
(IN rid_ VARCHAR(10),IN isbn_ VARCHAR(20),IN bname_ VARCHAR(30),IN sid_ VARCHAR(10),OUT result INT)
BEGIN
	DECLARE daylimit_ INT;
	DECLARE repayment_ date;
	DECLARE old_repay date;
	DECLARE rrid_ INT;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE;
	SET @@autocommit=0;
	START TRANSACTION;
	SELECT RRID FROM reader_info WHERE RID=rid_ INTO rrid_;
	SELECT day_limit FROM reader_info a,reader_type b WHERE a.RTID=b.RTID AND a.RID=rid_ INTO daylimit_;
	IF isbn_ IS NOT NULL THEN

	SELECT repayment_time FROM book_borrow a,reader_info b WHERE a.BRID=b.BRID and b.RID=rid_ INTO old_repay;
	SELECT DATE_ADD(old_repay,INTERVAL daylimit_ DAY) INTO repayment_;
	UPDATE book_borrow SET repayment_time=repayment_ AND renew_num=renew_num+1 WHERE RRID=rrid_;
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END;
```

### returnBook

```sql
-- 用来进行图书归还
CREATE PROCEDURE returnBook
(IN rid_ VARCHAR(10),IN sid_ VARCHAR(10),IN mid_ VARCHAR(10),OUT result INT)
BEGIN
	DECLARE srid_ INT;
	DECLARE rrid_ INT;
	DECLARE mrid_ INT;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE;
	SET @@autocommit=0;
	START TRANSACTION;
	SELECT RRID FROM reader_info WHERE RID=rid_ INTO rrid_;
	SELECT SRID FROM book_store_info WHERE SID=sid_ INTO srid_;
	SELECT MRID FROM manager_info WHERE MID=mid_ INTO mrid_;
	UPDATE book_return SET MRID=mrid_,return_time=NOW() WHERE RRID=rrid_ AND SRID=srid_;
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END;
```

### updateBook

```sql
-- 用来修改图书基本信息
CREATE PROCEDURE updateBook
(IN brid_ INT,IN isbn_ VARCHAR(4),IN bname_ VARCHAR(10),IN author_ VARCHAR(10),IN ename_ VARCHAR(30),IN editid_ VARCHAR(30),IN etime_ DATE,IN totalnum_ INT,IN currnum_ INT,IN price_ INT,IN abstract_ TEXT,OUT result INT)
BEGIN
	DECLARE phid_ INT;
	DECLARE brid_ INT;
	DECLARE cnt INT;
	DECLARE sid_ VARCHAR(10);
	SELECT PHID FROM edit_house_info WHERE EName=ename_ LIMIT 1 INTO phid_;
	SELECT BRID FROM book_info WHERE ISBN=isbn_ INTO brid_;
	UPDATE book_info SET BName=bname_,author=author_,abstract=abstract_,total_amount=totalnum_,current_amount=currnum_ WHERE BRID=brid_;
	UPDATE book_edit_info SET PHID=phid_ WHERE BRID=brid_;
	UPDATE book_date_info SET edit_ID=editid_,edit_date=etime_ WHERE BRID=brid_;
	UPDATE book_price_info SET price=price_ WHERE BRID=brid_;
	SET cnt=totalnum_;
	SELECT SID FROM book_store_info WHERE BRID=brid_ LIMIT 1 INTO sid_;
	DELETE FROM book_store_info WHERE BRID=brid_;
	loop_label: LOOP
		SELECT createSID(brid_,sid_) into sid_;
		-- 这里逻辑好像是有点bug的
		-- 我设置编号小于在库数量的都标记为在库，大于的就标记为借出了
		IF cnt>currnum_ THEN
			INSERT INTO book_store_info VALUES(NULL,sid_,brid_,0,etime_);
		ELSE
			INSERT INTO book_store_info VALUES(NULL,sid_,brid_,1,etime_);
		END IF;
		SET cnt=cnt-1;
		IF cnt=0 THEN
			LEAVE loop_label; 
		END IF; 
	END LOOP;
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END;
```

### updateBorrow

```sql
-- 用来进行超期信息更新
CREATE PROCEDURE updateBorrow
(IN rid_ VARCHAR(10),IN sid_ VARCHAR(10),IN mid_ VARCHAR(10),OUT result INT)
BEGIN
	DECLARE srid_ INT;
	DECLARE rrid_ INT;
	DECLARE mrid_ INT;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE;
	SET @@autocommit=0;
	START TRANSACTION;
	SELECT RRID FROM reader_info WHERE RID=rid_ INTO rrid_;
	SELECT SRID FROM book_store_info WHERE SID=sid_ INTO srid_;
	SELECT MRID FROM manager_info WHERE MID=mid_ INTO mrid_;
	UPDATE book_return SET overdue=1 WHERE RRID=rrid_ AND SRID=srid_;
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END;
```

### updateFineAll

```sql
-- 用来更新罚款信息
CREATE PROCEDURE updateFineAll(IN mid_ VARCHAR(10),OUT result INT)
BEGIN
	DECLARE srid_ INT	;
	DECLARE rrid_ INT;
	DECLARE mrid_ INT;
	DECLARE repayment_ date;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE;
	SET @@autocommit=0;
	START TRANSACTION;
	SELECT MRID FROM manager_info WHERE MID=mid_ INTO mrid_;
	SELECT repayment_time FROM book_borrow WHERE RRID=rrid_ AND SRID=srid_ INTO repayment_;
	SELECT insertFine(mrid_,RRID,SRID,repayment_) FROM book_borrow WHERE repayment_time<NOW();
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END
```

### updateReader

```sql
CREATE PROCEDURE updateReader
(IN rrid_ INT,IN rname_ VARCHAR(30),IN rtype_ VARCHAR(30),IN sex_ INT,IN currbor_ INT,IN totalbor_ INT,IN tel_ VARCHAR(11),IN effi_ date,IN state_ INT,IN violatenum_ INT,IN remark_ text,OUT result INT)
BEGIN
	DECLARE rtid_ INT;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE;
	SET @@autocommit=0;
	START TRANSACTION;
	SELECT RTID FROM reader_type WHERE RTName=rtype_ INTO rtid_;
	UPDATE reader_info SET RName=rname_,RTID=rtid_,sex=sex_,tmp_borrow_num=currbor_,acc_borrow_num=totalbor_,tel=tel_,effiency_date=effi_,state=state_,volate_num=violatenum_,remark=remark_ WHERE RRID=rrid_;
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END;
```

### updateStore

```sql
CREATE PROCEDURE updateStore
(IN srid_ INT,IN state_ INT,IN whtime_ DATE,OUT result INT)
BEGIN
	DECLARE brid_ INT;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION set @err_flag=TRUE;
	SET @err_flag=FALSE;
	SET @@autocommit=0;
	START TRANSACTION;
	SELECT BRID FROM book_store_info WHERE SRID=srid_ INTO brid_;
	UPDATE book_store_info SET state=state_,warehousing_date=whtime_ WHERE SRID=srid_;
	IF state_ =0 THEN
		UPDATE book_info SET current_amount=current_amount-1 WHERE BRID=brid_;
	ELSE
		UPDATE book_info SET current_amount=current_amount+1 WHERE BRID=brid_;
	END IF;
	IF @err_flag=FALSE THEN
		COMMIT;
		SET @@autocommit=1;
		SET result=1;
	ELSE
		ROLLBACK;
		SET @@autocommit=1;
		SET result=-1;
	END IF;
END;
```

## 函数

### createSID

```sql
-- 用来生成图书馆藏编号
delimiter $$
CREATE FUNCTION createSID(brid_ INT)
RETURNS VARCHAR(10)
BEGIN
	DECLARE sid_ VARCHAR(10);
	DECLARE var VARCHAR(10);
	DECLARE str1 VARCHAR(10);
	DECLARE str2 VARCHAR(10);
	DECLARE num INT;
	SELECT SID FROM book_store_info WHERE BRID=brid_ INTO var;
	IF var IS NULL THEN
		SELECT SID FROM book_store_info WHERE SRID=MAX(SRID) INTO var;
		IF var IS NULL THEN
			SET sid_="1001-1";
		ELSE
			SELECT SUBSTR(var,0,4)INTO str1;
			SELECT str1+1 INTO num;
			SELECT num+"" INTO str1;
			SELECT CONCAT(str,"-1") INTO sid_;
		END IF;
	ELSE
		SELECT SUBSTR(var,0,5)INTO str1;
		SELECT SUBSTR(var,5,LENGTH(var)-5)into str2;
		SELECT str2+1 INTO num;
		SELECT num+"" INTO str2;
		SELECT CONCAT(str1,str2) INTO sid_;
	END IF;
	RETURN sid_;
END $$
```

### insertFine

```sql
delimiter $$
CREATE FUNCTION insertFine(mrid_ INT,rrid_ INT,srid_ INT,repayment_ INT) RETURNS INT
BEGIN
	UPDATE book_return SET overdue=1 WHERE RRID=rrid_ AND SRID=srid_;
	UPDATE reader_info SET state=1,volate_num=volate_num+1 WHERE RRID=rrid_;
	INSERT INTO fine VALUES(mrid_,srid_,rrid_,0,0,repayment_,DATEDIFF(NOW(),repayment_));
	RETURN 0;
END
$$
```

## 页面

### 图书基本信息

```c#
 public partial class Frm_book_info : Form
    {
        private int brid;
        private string mname;
        //用于判断库存只能增加不能减少
        private int oldtotal;
        public event myDelegate returnEvent;
        public event myDelegate logoutEvent;
        public Frm_book_info(string mname)
        {
            this.mname = mname;
            InitializeComponent();
        }

        private void linkLabel1_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            returnEvent();
            this.Close();
        }

        private void linkLabel2_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            logoutEvent();
            this.Close();
        }

        protected void clearTextBox()
        {
            txt_ISBN.Text = "";
            txt_BName.Text = "";
            txt_author.Text = "";
            txt_Ename.Text = "";
            txt_edit_ID.Text = "";
            dt_pub_time.Value = DateTime.Now.Date;
            nu_total.Value = 0;
            nu_price.Value = 0;
            txt_abstract.Text = "";
            lbl_status.Text = "添加";
        }

        private void btn_save_Click(object sender, EventArgs e)
        {
            string ISBN=txt_ISBN.Text.Trim();
            string BName=txt_BName.Text.Trim();
            string author=txt_author.Text.Trim();
            string EName=txt_Ename.Text.Trim();
            string edit_ID=txt_edit_ID.Text.Trim();
            string edit_time=dt_pub_time.Value.ToString("yyyy-MM-dd");
            int total_num=((int)nu_total.Value);
            int price=((int)nu_price.Value);
            string Abstract=txt_abstract.Text.Trim();

            if (ISBN == "")
            {
                lbl_note.Text = "ISBN不能为空!";
                lbl_note.ForeColor=Color.Red;
                txt_ISBN.Focus();
            }
            else if (BName == "")
            {
                lbl_note.Text = "书名不能为空!";
                lbl_note.ForeColor = Color.Red;
                txt_BName.Focus();
            }
            else if (EName == "")
            {
                lbl_note.Text = "出版社名称不能为空!";
                lbl_note.ForeColor = Color.Red;
                txt_Ename.Focus();
            }
            else if (edit_ID == "")
            {
                lbl_note.Text = "版次不能为空!";
                lbl_note.ForeColor = Color.Red;
                txt_edit_ID.Focus();
            }
            else if (total_num == 0)
            {
                lbl_note.Text = "库存总量不能为空!";
                lbl_note.ForeColor = Color.Red;
                nu_total.Focus();
            }
            else if (price == 0)
            {
                lbl_note.Text = "价格不能为空!";
                lbl_note.ForeColor = Color.Red;
                nu_price.Focus();
            }
            else if (lbl_status.Text == "添加")
            {
                MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                conn.Open();
                MySqlCommand cmd = new MySqlCommand("addBook", conn);
                cmd.CommandType = CommandType.StoredProcedure;
                //定义输入函数
                cmd.Parameters.AddWithValue("isbn_", ISBN);
                cmd.Parameters.AddWithValue("bname_", BName);
                cmd.Parameters.AddWithValue("author_", author);
                cmd.Parameters.AddWithValue("ename_", EName);
                cmd.Parameters.AddWithValue("editid_", edit_ID);
                cmd.Parameters.AddWithValue("etime_", edit_time);
                cmd.Parameters.AddWithValue("totalnum_", total_num);
                cmd.Parameters.AddWithValue("price_", price);
                cmd.Parameters.AddWithValue("abstract_", Abstract);
                //定义输出函数
                MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                result.Direction = ParameterDirection.Output;
                cmd.ExecuteNonQuery();
                if (result.Value.ToString()=="1")
                {
                    lbl_note.Text = "恭喜你，添加成功！";
                    lbl_note.ForeColor = Color.Blue;
                    //trans.Commit();
                    //清空输入框
                    clearTextBox();
                    bind_book_info();
                }
                else
                {
                    lbl_note.Text = "对不起，添加失败！";
                    lbl_note.ForeColor = Color.Red;
                }
                conn.Close();
            }
            else
            {
                if (total_num < oldtotal)
                {
                    //库存只能增加不能减小
                    lbl_note.Text = "库存不能减少！";
                    lbl_note.ForeColor = Color.Red;
                    nu_total.Value = oldtotal;
                }
                else
                {
                    MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                    conn.Open();
                    MySqlCommand cmd = new MySqlCommand("updateBook", conn);
                    cmd.CommandType = CommandType.StoredProcedure;
                    //定义输入函数
                    cmd.Parameters.AddWithValue("brid_", brid);
                    cmd.Parameters.AddWithValue("isbn_", ISBN);
                    cmd.Parameters.AddWithValue("bname_", BName);
                    cmd.Parameters.AddWithValue("author_", author);
                    cmd.Parameters.AddWithValue("ename_", EName);
                    cmd.Parameters.AddWithValue("editid_", edit_ID);
                    cmd.Parameters.AddWithValue("etime_", edit_time);
                    cmd.Parameters.AddWithValue("totalnum_", total_num);
                    cmd.Parameters.AddWithValue("price_", price);
                    cmd.Parameters.AddWithValue("abstract_", Abstract);
                    //定义输出函数
                    MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                    result.Direction = ParameterDirection.Output;
                    cmd.ExecuteNonQuery();
                    if (result.Value.ToString() == "1")
                    {
                        lbl_note.Text = "恭喜你，修改成功！";
                        lbl_note.ForeColor = Color.Blue;
                        //清空输入框
                        clearTextBox();
                        bind_book_info();
                    }
                    else
                    {
                        lbl_note.Text = "对不起，修改失败！";
                        lbl_note.ForeColor = Color.Red;
                    }
                    conn.Close();
                }
            }
        }

        private void Frm_book_info_Load(object sender, EventArgs e)
        {
            lbl_mname.Text = mname;
            bind_book_info();
        }

        protected void bind_book_info()
        {
            MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
            conn.Open();
            string str = "select a.BRID,ISBN,BName,author,abstract,total_amount,current_amount,EName,edit_ID,edit_date,price from book_info a,book_edit_info b,book_price_info c,book_date_info d,edit_house_info e where a.BRID=b.BRID and a.BRID=c.BRID and a.BRID=d.BRID and b.PHID=e.PHID;";
            MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
            DataTable dt = new DataTable();
            msda.Fill(dt);
            conn.Close();
            listView1.Items.Clear();
            foreach (DataRow dr in dt.Rows)
            {
                ListViewItem myitem = new ListViewItem(dr["ISBN"].ToString());
                myitem.SubItems.Add(dr["BName"].ToString());
                myitem.SubItems.Add(dr["author"].ToString());
                myitem.SubItems.Add(dr["EName"].ToString());
                myitem.SubItems.Add(dr["edit_ID"].ToString());
                myitem.SubItems.Add(Convert.ToDateTime(dr["edit_date"]).ToString("yyyy-MM-dd"));
                myitem.SubItems.Add(dr["total_amount"].ToString());
                myitem.SubItems.Add(dr["current_amount"].ToString());
                myitem.SubItems.Add(dr["price"].ToString());
                myitem.SubItems.Add(dr["abstract"].ToString());
                //隐藏列BRID
                myitem.SubItems.Add(dr["BRID"].ToString());
                listView1.Items.Add(myitem);
            }
        }

        private void listView1_SelectedIndexChanged(object sender, EventArgs e)
        {
            if(listView1.SelectedItems.Count > 0)
            {
                ListViewItem myitem = listView1.SelectedItems[0];
                txt_ISBN.Text = myitem.SubItems[0].Text;
                txt_BName.Text = myitem.SubItems[1].Text;
                txt_author.Text = myitem.SubItems[2].Text;
                txt_Ename.Text = myitem.SubItems[3].Text;
                txt_edit_ID.Text = myitem.SubItems[4].Text;
                dt_pub_time.Value = DateTime.ParseExact(myitem.SubItems[5].Text, "yyyy-MM-dd", CultureInfo.InvariantCulture);
                nu_total.Value = int.Parse(myitem.SubItems[6].Text);
                nu_price.Value = int.Parse(myitem.SubItems[8].Text);
                txt_abstract.Text = myitem.SubItems[9].Text;
                lbl_status.Text = "修改";
                brid = int.Parse(myitem.SubItems[10].Text);
                oldtotal= int.Parse(myitem.SubItems[6].Text); ;
            }
        }

        private void btn_del_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count==0)
            {
                MessageBox.Show("请先选择要删除的书籍！");
            }
            else
            {
                DialogResult dResult = MessageBox.Show("确定要删除选择的书籍？", "删除提示", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (dResult == DialogResult.Yes)
                {
                    MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                    conn.Open();
                    MySqlCommand cmd = new MySqlCommand("deleteBook", conn);
                    cmd.CommandType = CommandType.StoredProcedure;
                    //定义输入函数
                    cmd.Parameters.AddWithValue("brid_", brid);
                    //定义输出函数
                    MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                    result.Direction = ParameterDirection.Output;
                    cmd.ExecuteNonQuery();
                    if (result.Value.ToString() == "1")
                    {
                        lbl_note.Text = "恭喜你，删除成功！";
                        lbl_note.ForeColor = Color.Blue;
                        //清空输入框
                        clearTextBox();
                        bind_book_info();
                    }
                    else
                    {
                        lbl_note.Text = "对不起，删除失败！";
                        lbl_note.ForeColor = Color.Red;
                    }
                    conn.Close();
                }
            }
        }

        private void btn_cancel_Click(object sender, EventArgs e)
        {
            clearTextBox();
            lbl_note.Text = "";
        }
    }
```

### 图书借阅管理

```c#
 public partial class Frm_borrow_manage : Form
    {
        private int brid;
        private string mname,mid;
        public event myDelegate returnEvent;
        public event myDelegate logoutEvent;
        public Frm_borrow_manage(string mname,string mid)
        {
            InitializeComponent();
            this.mname = mname;
            this.mid = mid;
        }


        private void linkLabel1_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            returnEvent();
            this.Close();
        }

        private void linkLabel2_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            logoutEvent();
            this.Close();
        }

        protected void bind_book_info()
        {
            MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
            conn.Open();
            string str = "select a.BRID,ISBN,BName,author,abstract,total_amount,current_amount,EName,edit_ID,edit_date,price from book_info a,book_edit_info b,book_price_info c,book_date_info d,edit_house_info e where a.BRID=b.BRID and a.BRID=c.BRID and a.BRID=d.BRID and b.PHID=e.PHID;";
            MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
            DataTable dt = new DataTable();
            msda.Fill(dt);
            conn.Close();
            listView1.Items.Clear();
            foreach (DataRow dr in dt.Rows)
            {
                ListViewItem myitem = new ListViewItem(dr["ISBN"].ToString());
                myitem.SubItems.Add(dr["BName"].ToString());
                myitem.SubItems.Add(dr["author"].ToString());
                myitem.SubItems.Add(dr["EName"].ToString());
                myitem.SubItems.Add(dr["edit_ID"].ToString());
                myitem.SubItems.Add(Convert.ToDateTime(dr["edit_date"]).ToString("yyyy-MM-dd"));
                myitem.SubItems.Add(dr["total_amount"].ToString());
                myitem.SubItems.Add(dr["current_amount"].ToString());
                myitem.SubItems.Add(dr["price"].ToString());
                myitem.SubItems.Add(dr["abstract"].ToString());
                //隐藏列BRID
                myitem.SubItems.Add(dr["BRID"].ToString());
                listView1.Items.Add(myitem);
            }
        }

        private void Frm_borrow_manage_Load(object sender, EventArgs e)
        {
            lbl_mname.Text = mname;
            bind_book_info();
        }

        private void listView1_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count > 0)
            {
                ListViewItem myitem = listView1.SelectedItems[0];
                txt_ISBN.Text = myitem.SubItems[0].Text;
                txt_BName.Text = myitem.SubItems[1].Text;
                txt_author.Text = myitem.SubItems[2].Text;
                txt_Ename.Text = myitem.SubItems[3].Text;
                txt_edit_ID.Text = myitem.SubItems[4].Text;
                brid = int.Parse(myitem.SubItems[10].Text);
            }
        }

        protected void clearTextBox()
        {
            txt_ISBN.Text = "";
            txt_BName.Text = "";
            txt_author.Text = "";
            txt_Ename.Text = "";
            txt_edit_ID.Text = "";
        }

        private void button1_Click(object sender, EventArgs e)
        {
            //实现模糊查找
            string ISBN=txt_ISBN.Text.Trim();
            string BName=txt_BName.Text.Trim();
            string author=txt_author.Text.Trim();
            string EName=txt_Ename.Text.Trim();
            string edit_ID=txt_edit_ID.Text;
            if (!(ISBN == "" && BName == "" && author == "" && EName == "" && edit_ID == ""))
            {
                if (edit_ID == "")
                {
                    MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                    conn.Open();
                    string str = string.Format("select a.BRID,ISBN,BName,author,abstract,total_amount,current_amount,EName,edit_ID,edit_date,price from book_info a,book_edit_info b,book_price_info c,book_date_info d,edit_house_info e where a.BRID=b.BRID and a.BRID=c.BRID and a.BRID=d.BRID and b.PHID=e.PHID " +
                        "and ISBN LIKE '%{0}%' AND BName LIKE '%{1}%' AND author LIKE '%{2}%' AND EName LIKE '%{3}%';", ISBN, BName, author, EName);
                    MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
                    DataTable dt = new DataTable();
                    msda.Fill(dt);
                    conn.Close();
                    listView1.Items.Clear();
                    foreach (DataRow dr in dt.Rows)
                    {
                        ListViewItem myitem = new ListViewItem(dr["ISBN"].ToString());
                        myitem.SubItems.Add(dr["BName"].ToString());
                        myitem.SubItems.Add(dr["author"].ToString());
                        myitem.SubItems.Add(dr["EName"].ToString());
                        myitem.SubItems.Add(dr["edit_ID"].ToString());
                        myitem.SubItems.Add(Convert.ToDateTime(dr["edit_date"]).ToString("yyyy-MM-dd"));
                        myitem.SubItems.Add(dr["total_amount"].ToString());
                        myitem.SubItems.Add(dr["current_amount"].ToString());
                        myitem.SubItems.Add(dr["price"].ToString());
                        myitem.SubItems.Add(dr["abstract"].ToString());
                        //隐藏列BRID
                        myitem.SubItems.Add(dr["BRID"].ToString());
                        listView1.Items.Add(myitem);
                    }
                }
                else
                {
                    int edit_id = int.Parse(edit_ID);
                    MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                    conn.Open();
                    string str = string.Format("select a.BRID,ISBN,BName,author,abstract,total_amount,current_amount,EName,edit_ID,edit_date,price from book_info a,book_edit_info b,book_price_info c,book_date_info d,edit_house_info e where a.BRID=b.BRID and a.BRID=c.BRID and a.BRID=d.BRID and b.PHID=e.PHID " +
                        "and ISBN LIKE '%{0}%' AND BName LIKE '%{1}%' AND author LIKE '%{2}%' AND EName LIKE '%{3}%' AND edit_ID={4};", ISBN, BName, author, EName, edit_id);
                    MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
                    DataTable dt = new DataTable();
                    msda.Fill(dt);
                    conn.Close();
                    listView1.Items.Clear();
                    foreach (DataRow dr in dt.Rows)
                    {
                        ListViewItem myitem = new ListViewItem(dr["ISBN"].ToString());
                        myitem.SubItems.Add(dr["BName"].ToString());
                        myitem.SubItems.Add(dr["author"].ToString());
                        myitem.SubItems.Add(dr["EName"].ToString());
                        myitem.SubItems.Add(dr["edit_ID"].ToString());
                        myitem.SubItems.Add(Convert.ToDateTime(dr["edit_date"]).ToString("yyyy-MM-dd"));
                        myitem.SubItems.Add(dr["total_amount"].ToString());
                        myitem.SubItems.Add(dr["current_amount"].ToString());
                        myitem.SubItems.Add(dr["price"].ToString());
                        myitem.SubItems.Add(dr["abstract"].ToString());
                        //隐藏列BRID
                        myitem.SubItems.Add(dr["BRID"].ToString());
                        listView1.Items.Add(myitem);
                    }
                }
            }
        }

        private void button2_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count == 0)
            {
                MessageBox.Show("请先选择要借阅的书籍！");
            }
            else if (listView1.SelectedItems[0].SubItems[7].Text == "0")
            {
                lbl_note.Text = "该书在库数量为零，借阅失败！";
                lbl_note.ForeColor= Color.Red;
            }
            else
            {
                Frm_reader_info frm= new Frm_reader_info();
                frm.ShowDialog();
                string rid = frm.get_rid();
                if (rid!=null)
                {
                    MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                    conn.Open();
                    string str = string.Format("select state,tmp_borrow_num,borrow_limit from reader_info a,reader_type b where RID='{0}' and a.RTID=b.RTID;",rid);
                    MySqlDataAdapter msda=new MySqlDataAdapter(str, conn);
                    DataTable dt=new DataTable();
                    msda.Fill(dt);
                    if (dt.Rows.Count == 0)
                    {
                        DialogResult dResult0 = MessageBox.Show("输入读者号不存在！");
                    }
                    else
                    {
                        foreach (DataRow dr in dt.Rows)
                        {
                            if (dr["state"].ToString() == "1")
                            {
                                DialogResult dResult = MessageBox.Show("你有罚款未缴清，是否前往缴费？缴费后方可借阅。", "系统提示", MessageBoxButtons.YesNo);
                                if (dResult == DialogResult.Yes)
                                {
                                    Frm_fine_manage frm1 = new Frm_fine_manage(mname, mid);
                                    frm1.returnEvent += new myDelegate(Frm_returnEvent);
                                    frm1.Show();
                                    this.Hide();
                                }
                            }
                            else if (int.Parse(dr["tmp_borrow_num"].ToString()) == int.Parse(dr["borrow_limit"].ToString()))
                            {
                                lbl_note.Text = "已超过最大借阅数量！";
                                lbl_note.ForeColor = Color.Red;
                            }
                            else
                            {
                                MySqlCommand cmd = new MySqlCommand("borrowBook", conn);
                                cmd.CommandType = CommandType.StoredProcedure;
                                //定义输入函数
                                cmd.Parameters.AddWithValue("brid_", brid);
                                cmd.Parameters.AddWithValue("rid_", rid);
                                cmd.Parameters.AddWithValue("mid_", mid);
                                //定义输出函数
                                MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                                result.Direction = ParameterDirection.Output;
                                cmd.ExecuteNonQuery();
                                if (result.Value.ToString() == "1")
                                {
                                    lbl_note.Text = "恭喜你，借阅成功！";
                                    lbl_note.ForeColor = Color.Blue;
                                    //清空输入框
                                    clearTextBox();
                                    bind_book_info();
                                }
                                else
                                {
                                    lbl_note.Text = "对不起，借阅失败！";
                                    lbl_note.ForeColor = Color.Red;
                                }
                            }
                        }
                    }
                    conn.Close();
                }
            }
        }

        private void Frm_returnEvent()
        {
            this.Show();
            bind_book_info();
        }

        private void btn_cancel_Click(object sender, EventArgs e)
        {
            clearTextBox();
            bind_book_info();
        }
    }
```

### 图书缴费页面

```c#
public partial class Frm_fine_manage : Form
    {
        private string mname,mid;
        public event myDelegate returnEvent;
        public event myDelegate logoutEvent;
        public Frm_fine_manage(string mname,string mid)
        {
            this.mname = mname;
            this.mid = mid;
            InitializeComponent();
        }

        private void linkLabel1_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            returnEvent();
            this.Close();
        }

        private void linkLabel2_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            logoutEvent();
            this.Close();
        }

        private void Frm_fine_manage_Load(object sender, EventArgs e)
        {
            lbl_mname.Text = mname;
            cb_head.SelectedIndex = 0;
            MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
            conn.Open();
            MySqlCommand cmd = new MySqlCommand("updateFineAll", conn);
            cmd.CommandType = CommandType.StoredProcedure;
            //定义输入函数
            cmd.Parameters.AddWithValue("mid_", mid);
            //定义输出函数
            MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
            result.Direction = ParameterDirection.Output;
            cmd.ExecuteNonQuery();
            conn.Close();
            bind_fine_manage();
        }

        private void bind_fine_manage()
        {
            MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
            conn.Open();
            string str = "select RID,SID,ISBN,BName,author,EName,edit_ID,price,default_type,default_time,g.pay,fine_num " +
                "from reader_info a,book_info b,book_store_info c,book_edit_info d,edit_house_info e,book_date_info f,fine g,book_price_info h" +
                " where b.BRID=c.BRID and d.PHID=e.PHID and b.BRID=d.BRID and b.BRID=f.BRID and a.RRID=g.RRID and c.SRID=g.SRID and h.BRID=b.BRID;";
            MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
            DataTable dt = new DataTable();
            msda.Fill(dt);
            conn.Close();
            listView1.Items.Clear();
            foreach (DataRow dr in dt.Rows)
            {
                ListViewItem myitem = new ListViewItem(dr["RID"].ToString());
                myitem.SubItems.Add(dr["SID"].ToString());
                myitem.SubItems.Add(dr["ISBN"].ToString());
                myitem.SubItems.Add(dr["BName"].ToString());
                myitem.SubItems.Add(dr["author"].ToString());
                myitem.SubItems.Add(dr["EName"].ToString());
                myitem.SubItems.Add(dr["edit_ID"].ToString());
                myitem.SubItems.Add(dr["price"].ToString());
                if (dr["default_type"].ToString() == "0")
                {
                    myitem.SubItems.Add("超期");
                }
                else
                {
                    myitem.SubItems.Add("损坏");
                }
                myitem.SubItems.Add(Convert.ToDateTime(dr["default_time"]).ToString("yyyy-MM-dd"));
                if (dr["pay"].ToString() == "False")
                {
                    myitem.SubItems.Add("未交款");
                }
                else
                {
                    myitem.SubItems.Add("已交款");
                }
                myitem.SubItems.Add(dr["fine_num"].ToString());
                listView1.Items.Add(myitem);
            }
        }

        private void button1_Click(object sender, EventArgs e)
        {
            DialogResult dResult = MessageBox.Show(string.Format("确认支付{0}？", lbl_fine.Text), "支付提示", MessageBoxButtons.YesNo);
            if (dResult == DialogResult.Yes)
            {
                MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                conn.Open();
                MySqlCommand cmd = new MySqlCommand("payFine", conn);
                cmd.CommandType = CommandType.StoredProcedure;
                string rid = listView1.SelectedItems[0].SubItems[0].Text;
                string sid = listView1.SelectedItems[0].SubItems[1].Text;
                //定义输入函数
                cmd.Parameters.AddWithValue("rid_", rid);
                cmd.Parameters.AddWithValue("sid_", sid);
                cmd.Parameters.AddWithValue("mid_", mid);
                //定义输出函数
                MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                result.Direction = ParameterDirection.Output;
                cmd.ExecuteNonQuery();
                conn.Close();
                if (result.Value.ToString() == "1")
                {
                    MessageBox.Show("恭喜你，支付成功！");
                    clearTextBox();
                }
                else
                {
                    MessageBox.Show("对不起，支付失败！");
                }
                bind_fine_manage();
            }
        }

        private void button4_Click(object sender, EventArgs e)
        {
            string rid = txt_rid.Text.Trim();
            string isbn = "", sid = "", bname = "";
            if (cb_head.SelectedIndex == 0) { bname = txt_book.Text.Trim(); }
            else if (cb_head.SelectedIndex == 1) { isbn = txt_book.Text.Trim(); }
            else { sid = txt_book.Text.Trim(); }
            MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
            conn.Open();
            string str = string.Format("select RID, SID, ISBN, BName, author, EName, edit_ID, price, default_type, default_time, g.pay, fine_num " +
                "from reader_info a,book_info b,book_store_info c,book_edit_info d,edit_house_info e,book_date_info f,fine g,book_price_info h" +
                " where b.BRID=c.BRID and d.PHID=e.PHID and b.BRID=d.BRID and b.BRID=f.BRID and a.RRID=g.RRID and c.SRID=g.SRID and h.BRID=b.BRID " +
                "and RID like '%{0}%' and BName like '%{1}%' and ISBN like '%{2}%' and SID like'%{3}%';", rid, bname, isbn, sid);
            MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
            DataTable dt = new DataTable();
            msda.Fill(dt);
            conn.Close();
            listView1.Items.Clear();
            foreach (DataRow dr in dt.Rows)
            {
                ListViewItem myitem = new ListViewItem(dr["RID"].ToString());
                myitem.SubItems.Add(dr["SID"].ToString());
                myitem.SubItems.Add(dr["ISBN"].ToString());
                myitem.SubItems.Add(dr["BName"].ToString());
                myitem.SubItems.Add(dr["author"].ToString());
                myitem.SubItems.Add(dr["EName"].ToString());
                myitem.SubItems.Add(dr["edit_ID"].ToString());
                myitem.SubItems.Add(dr["price"].ToString());
                if (dr["default_type"].ToString() == "0")
                {
                    myitem.SubItems.Add("超期");
                }
                else
                {
                    myitem.SubItems.Add("损坏");
                }
                myitem.SubItems.Add(Convert.ToDateTime(dr["default_time"]).ToString("yyyy-MM-dd"));
                if (dr["pay"].ToString() == "False")
                {
                    myitem.SubItems.Add("未交款");
                }
                else
                {
                    myitem.SubItems.Add("已交款");
                }
                myitem.SubItems.Add(dr["fine_num"].ToString());
                listView1.Items.Add(myitem);
            }
        }

        private void cb_head_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count > 0)
            {
                ListViewItem myitem = listView1.SelectedItems[0];
                if (cb_head.SelectedIndex == 0) { txt_book.Text = myitem.SubItems[3].Text; }
                else if (cb_head.SelectedIndex == 1) { txt_book.Text = myitem.SubItems[2].Text; }
                else { txt_book.Text = myitem.SubItems[1].Text; }
            }
        }

        private void button3_Click(object sender, EventArgs e)
        {
            clearTextBox();
            bind_fine_manage();
        }

        private void clearTextBox()
        {
            txt_book.Text = string.Empty;
            txt_rid.Text = string.Empty;
            lbl_fine.Text = "元";
            cb_head.SelectedIndex = 0;
        }

        private void button2_Click(object sender, EventArgs e)
        {
            clearTextBox();
        }

        private void listView1_SelectedIndexChanged(object sender, EventArgs e)
        {
            lbl_fine.Text = listView1.SelectedItems[0].SubItems[11].Text+"元";
            ListViewItem myitem = listView1.SelectedItems[0];
            txt_rid.Text = myitem.SubItems[0].Text;
            if (cb_head.SelectedIndex == 0) { txt_book.Text = myitem.SubItems[2].Text; }
            else if (cb_head.SelectedIndex == 1) { txt_book.Text = myitem.SubItems[3].Text; }
            else { txt_book.Text = myitem.SubItems[1].Text; }
        }
    }
```

### 登录

```c#
public partial class Frm_login : Form
    {
        private string mid;
        private string mname;
        public Frm_login()
        {
            InitializeComponent();
        }

        private void button1_Click(object sender, EventArgs e)
        {
            if (txt_UserName.Text.Trim() == "")
            {
                MessageBox.Show("请输入用户名！");
                txt_UserName.Focus();
            }
            else if (txt_Password.Text.Trim() == "")
            {
                MessageBox.Show("请输入密码！");
                txt_Password.Focus();
            }
            else
            {
                MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                conn.Open();
                string str = string.Format("select MID,MName from manager_info where UserName='{0}' and Password='{1}'",
                    txt_UserName.Text, txt_Password.Text);
                MySqlDataAdapter da = new MySqlDataAdapter(str, conn);
                DataTable dt = new DataTable();
                da.Fill(dt);
                conn.Close();
                if (dt.Rows.Count == 1)
                {
                    foreach(DataRow dr in dt.Rows)
                    {
                        mid = dr["MID"].ToString();
                        mname = dr["MName"].ToString();
                    }
                    Frm_main frm = new Frm_main(mname,mid);
                    frm.logoutEvent += new myDelegate(Frm_logoutEvent);
                    frm.Show();
                    clearTextBox();
                    this.Hide();
                }
                else
                {
                    MessageBox.Show("对不起，用户名或密码不正确！");
                }
            }
        }

        private void clearTextBox()
        {
            txt_UserName.Text = "";
            txt_Password.Text = "";
        }

        private void Frm_logoutEvent()
        {
            this.Show();
        }
    }
```

### 主界面

```c#
public partial class Frm_main : Form
    {
        public event myDelegate logoutEvent;
        private string mname,mid;
        public Frm_main(string mname,string mid)
        {
            this.mname = mname;
            this.mid = mid;
            InitializeComponent();
        }
        //public Frm_main()
        //{
        //    InitializeComponent();
        //}

        private void button1_Click(object sender, EventArgs e)
        {
            this.Hide();
            Frm_reader_manage frm = new Frm_reader_manage(mname);
            frm.returnEvent += new myDelegate(Frm_returnEvent);
            frm.logoutEvent += new myDelegate(Frm_logoutEvent);
            frm.Show();
        }

        private void button2_Click(object sender, EventArgs e)
        {
            this.Hide();
            Frm_pub_manage frm = new Frm_pub_manage(mname);
            frm.returnEvent += new myDelegate(Frm_returnEvent);
            frm.logoutEvent += new myDelegate(Frm_logoutEvent);
            frm.Show();
        }

        private void Frm_returnEvent()
        {
            this.Show();
        }

        private void button3_Click(object sender, EventArgs e)
        {
            this.Hide();
            Frm_book_info frm = new Frm_book_info(mname);
            frm.returnEvent += new myDelegate(Frm_returnEvent);
            frm.logoutEvent += new myDelegate(Frm_logoutEvent);
            frm.Show();
        }

        private void Frm_logoutEvent()
        {
            logoutEvent();
            this.Close();
        }

        private void button4_Click(object sender, EventArgs e)
        {
            this.Hide();
            Frm_store_info frm = new Frm_store_info(mname);
            frm.returnEvent += new myDelegate(Frm_returnEvent);
            frm.logoutEvent += new myDelegate(Frm_logoutEvent);
            frm.Show();
        }

        private void button5_Click(object sender, EventArgs e)
        {
            this.Hide();
            Frm_borrow_manage frm = new Frm_borrow_manage(mname,mid);
            frm.returnEvent += new myDelegate(Frm_returnEvent);
            frm.logoutEvent += new myDelegate(Frm_logoutEvent);
            frm.Show();
        }


        private void button6_Click(object sender, EventArgs e)
        {
            this.Hide();
            Frm_return_manage frm = new Frm_return_manage(mname,mid) ;
            frm.returnEvent += new myDelegate(Frm_returnEvent);
            frm.logoutEvent += new myDelegate(Frm_logoutEvent);
            frm.Show();
        }

        private void button7_Click(object sender, EventArgs e)
        {
            this.Hide();
            Frm_fine_manage frm = new Frm_fine_manage(mname,mid);
            frm.returnEvent += new myDelegate(Frm_returnEvent);
            frm.logoutEvent += new myDelegate(Frm_logoutEvent);
            frm.Show();
        }

        private void linkLabel1_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            logoutEvent();
            this.Close();
        }

        private void Frm_main_Load(object sender, EventArgs e)
        {
            lbl_mname.Text = mname;
        }
    }
```

### 出版社信息

```c#
public partial class Frm_pub_manage : Form
    {
        public event myDelegate returnEvent;
        public event myDelegate logoutEvent;
        private string mname;
        public Frm_pub_manage(string mname)
        {
            this.mname = mname;
            InitializeComponent();
        }

        private void linkLabel1_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            this.Hide();
            returnEvent();
        }

        private void linkLabel2_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            logoutEvent();
            this.Close();
        }

        private void label4_Click(object sender, EventArgs e)
        {

        }

        protected void bind_pub_info()
        {
            MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
            conn.Open();
            string str = "select * from edit_house_info;";
            MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
            DataTable dt = new DataTable();
            msda.Fill(dt);
            conn.Close();
            listView1.Items.Clear();
            foreach (DataRow dr in dt.Rows)
            {
                ListViewItem myitem = new ListViewItem(dr["PHID"].ToString());
                myitem.SubItems.Add(dr["EName"].ToString());
                myitem.SubItems.Add(dr["contacts"].ToString());
                myitem.SubItems.Add(dr["tel"].ToString());
                myitem.SubItems.Add(dr["email"].ToString());
                myitem.SubItems.Add(dr["address"].ToString());
                listView1.Items.Add(myitem);
            }
        }

        private void Frm_pub_manage_Load(object sender, EventArgs e)
        {
            lbl_mname.Text = mname;
            bind_pub_info();
        }

        protected void clearTextbox()
        {
            txt_EName.Text = "";
            txt_contacts.Text = "";
            txt_tel.Text = "";
            txt_email.Text = "";
            txt_address.Text = "";
            lbl_status.Text = "添加";
        }

        private void btb_save_Click(object sender, EventArgs e)
        {
            string ename=txt_EName.Text.Trim();
            string tel=txt_tel.Text.Trim();
            string contacts=txt_contacts.Text.Trim();
            string email=txt_email.Text.Trim();
            string address=txt_address.Text.Trim();
            if (ename == "")
            {
                lbl_note.Text = "出版社名称不能为空！";
                lbl_note.ForeColor= Color.Red;
                txt_EName.Focus();
            }
            else if (lbl_status.Text == "添加")
            {
                MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                conn.Open();
                string str = string.Format("insert into edit_house_info values(null,'{0}','{1}','{2}','{3}','{4}');", ename, contacts, tel, email, address);
                MySqlCommand cmd= new MySqlCommand(str, conn);
                int i = cmd.ExecuteNonQuery();
                conn.Close();
                if(i>0)
                {
                    lbl_note.Text = "恭喜你，添加成功！";
                    lbl_note.ForeColor = Color.Blue;
                    bind_pub_info();
                    clearTextbox();
                }
                else
                {
                    lbl_note.Text = "对不起，添加失败！";
                    lbl_note.ForeColor = Color.Red;
                }
            }
            else
            {
                MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                conn.Open();
                int PHID = int.Parse(listView1.SelectedItems[0].SubItems[0].Text);
                string str = string.Format("update edit_house_info set EName='{0}',contacts='{1}',tel='{2}',email='{3}',address='{4}' where PHID={5};", ename, contacts, tel, email, address, PHID);
                MySqlCommand cmd = new MySqlCommand(str, conn);
                int i = cmd.ExecuteNonQuery();
                conn.Close();
                if(i>0)
                {
                    lbl_note.Text = "恭喜你，修改成功！";
                    lbl_note.ForeColor = Color.Blue;
                    bind_pub_info();
                    clearTextbox();
                }
                else
                {
                    lbl_note.Text = "对不起，修改失败！";
                    lbl_note.ForeColor = Color.Red;
                }
            }
        }

        private void listView1_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count > 0)
            {
                ListViewItem myitem = listView1.SelectedItems[0];
                txt_EName.Text = myitem.SubItems[1].Text;
                txt_contacts.Text = myitem.SubItems[2].Text;
                txt_tel.Text = myitem.SubItems[3].Text;
                txt_email.Text = myitem.SubItems[4].Text;
                txt_address.Text = myitem.SubItems[5].Text;
                lbl_status.Text = "修改";
            }
        }

        private void btn_del_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count == 0)
            {
                MessageBox.Show("请先选择要删除的出版社！");
            }
            else
            {
                MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                conn.Open();
                int PHID = int.Parse(listView1.SelectedItems[0].SubItems[0].Text);
                string str = string.Format("delete from edit_house_info where PHID={0};", PHID);
                MySqlCommand cmd = new MySqlCommand(str, conn);
                int i = cmd.ExecuteNonQuery();
                conn.Close();
                if (i > 0)
                {
                    lbl_note.Text = "恭喜你，删除成功！";
                    lbl_note.ForeColor = Color.Blue;
                    bind_pub_info();
                    clearTextbox();
                }
                else
                {
                    lbl_note.Text = "对不起，删除失败！";
                    lbl_note.ForeColor = Color.Red;
                }
            }
        }

        private void btn_cancel_Click(object sender, EventArgs e)
        {
            clearTextbox();
            lbl_note.Text = "";
        }
    }
```

### 读者编号输入框

```c#
public partial class Frm_reader_info : Form
    {
        private string rid;
        public Frm_reader_info()
        {
            InitializeComponent();
        }

        private void button1_Click(object sender, EventArgs e)
        {
            rid=txt_rid.Text.Trim();
            this.Hide();
        }

        public string get_rid()
        {
            return rid;
        }

        private void button2_Click(object sender, EventArgs e)
        {
            this.Hide();
        }
    }
```

### 读者基本信息

```c#
public partial class Frm_reader_manage : Form
    {
        private int rrid;
        private string mname;
        public event myDelegate returnEvent;
        public event myDelegate logoutEvent;
        public Frm_reader_manage(string mname)
        {
            this.mname = mname;
            InitializeComponent();
        }


        private void linkLabel2_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            logoutEvent();
            this.Close();
        }

        protected void bind_reader_info()
        {
            MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
            conn.Open();
            string str = "select RRID,RID,RName,a.RTID,sex,tel,tmp_borrow_num,acc_borrow_num,register_date,effiency_date,borrow_limit,day_limit,volate_num,state,remark from reader_info a,reader_type b where a.RTID=b.RTID;";
            MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
            DataTable dt = new DataTable();
            msda.Fill(dt);
            conn.Close();
            lv_reader.Items.Clear();
            foreach (DataRow dr in dt.Rows)
            {
                ListViewItem myitem = new ListViewItem(dr["RID"].ToString());
                myitem.SubItems.Add(dr["RName"].ToString());
                if (dr["RTID"].ToString() == "0")
                {
                    myitem.SubItems.Add("学生");
                }
                else if (dr["RTID"].ToString() == "1")
                {
                    myitem.SubItems.Add("教师");
                }
                else
                {
                    myitem.SubItems.Add("职工");
                }
                myitem.SubItems.Add(dr["sex"].ToString()=="0"?"女":"男");
                myitem.SubItems.Add(dr["tel"].ToString());
                myitem.SubItems.Add(dr["tmp_borrow_num"].ToString());
                myitem.SubItems.Add(dr["acc_borrow_num"].ToString());
                myitem.SubItems.Add(Convert.ToDateTime(dr["register_date"]).ToString("yyyy-MM-dd"));
                myitem.SubItems.Add(Convert.ToDateTime(dr["effiency_date"]).ToString("yyyy-MM-dd"));
                myitem.SubItems.Add(dr["borrow_limit"].ToString());
                myitem.SubItems.Add(dr["day_limit"].ToString());
                myitem.SubItems.Add(dr["volate_num"].ToString());
                myitem.SubItems.Add(dr["state"]. ToString()=="0"?"正常":"违规");
                myitem.SubItems.Add(dr["remark"].ToString());
                //隐藏列RRID
                myitem.SubItems.Add(dr["RRID"].ToString());
                lv_reader.Items.Add(myitem);
            }
        }

        protected void clearTextBox()
        {
            txt_RName.Text = "";
            cb_rtype.Text = "";
            btn_sex1.Checked= true;
            btn_sex2.Checked= false;
            nu_curr.Value = 0;
            nu_total.Value = 0;
            nu_violate.Value = 0;
            txt_tel.Text = "";
            dt_effi.Value = DateTime.Now.Date;
            cmb_state.Text = "";
            txt_remark.Text = "";
            lbl_status.Text = "添加";
        }

        private void btn_save_Click(object sender, EventArgs e)
        {
            string RName=txt_RName.Text.Trim();
            string RType=cb_rtype.Text.Trim();
            //0--女，1--男
            int sex=btn_sex1.Checked==true ? 1 : 0;
            int currbor = int.Parse(nu_curr.Value.ToString());
            int totalbor = int.Parse(nu_total.Value.ToString());
            string tel=txt_tel.Text.Trim();
            string effiency = dt_effi.Value.ToString("yyyy-MM-dd");
            //0--正常，1--违规
            int state = cmb_state.Text == "违规" ? 1 : 0;
            int violatenum=int.Parse(nu_violate.Value.ToString());
            string remark=txt_remark.Text.Trim();
            if (RName == "")
            {
                lbl_note.Text = "姓名不能为空！";
                lbl_note.ForeColor = Color.Red;
                txt_RName.Focus();
            }
            else if (RType == "")
            {
                lbl_note.Text = "读者类别不能为空！";
                lbl_note.ForeColor = Color.Red;
                cb_rtype.Focus();
            }
            else if (cmb_state.Text.Trim() == "")
            {
                lbl_note.Text = "状态不能为空！";
                lbl_note.ForeColor = Color.Red;
                cmb_state.Focus();
            }
            else if (currbor > totalbor)
            {
                lbl_note.Text = "现借数量不能大于已借数量！";
                lbl_note.ForeColor = Color.Red;
                nu_curr.Focus();
            }
            else if (state == 1 && violatenum == 0)
            {
                lbl_note.Text = "违规次数和状态矛盾！";
                lbl_note.ForeColor = Color.Red;
                nu_violate.Focus();
            }
            else if(lbl_status.Text=="添加")
            {
                MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                conn.Open();
                string str = string.Format("select borrow_limit from reader_type where RTName='{0}'", RType);
                MySqlDataAdapter msda=new MySqlDataAdapter(str, conn);
                DataTable dt=new DataTable();
                msda.Fill(dt);
                conn.Close();
                int borrowLimit=-1;
                foreach (DataRow dr in dt.Rows)
                {
                    borrowLimit = int.Parse(dr["borrow_limit"].ToString());
                }
                if (currbor > borrowLimit)
                {
                    lbl_note.Text = "最多可借" + borrowLimit + "本！";
                    lbl_note.ForeColor = Color.Red;
                    nu_curr.Focus();
                }
                else
                {
                    conn.Open();
                    MySqlCommand cmd = new MySqlCommand("addReader", conn);
                    cmd.CommandType = CommandType.StoredProcedure;
                    //定义输入函数
                    cmd.Parameters.AddWithValue("rname_", RName);
                    cmd.Parameters.AddWithValue("rtype_", RType);
                    cmd.Parameters.AddWithValue("sex_", sex);
                    cmd.Parameters.AddWithValue("currbor_", currbor);
                    cmd.Parameters.AddWithValue("totalbor_", totalbor);
                    cmd.Parameters.AddWithValue("tel_", tel);
                    cmd.Parameters.AddWithValue("effi_", effiency);
                    cmd.Parameters.AddWithValue("state_", state);
                    cmd.Parameters.AddWithValue("violatenum_", violatenum);
                    cmd.Parameters.AddWithValue("remark_", remark);
                    //定义输出函数
                    MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                    result.Direction = ParameterDirection.Output;
                    cmd.ExecuteNonQuery();
                    if (result.Value.ToString() == "1")
                    {
                        lbl_note.Text = "恭喜你，添加成功！";
                        lbl_note.ForeColor = Color.Blue;
                        //trans.Commit();
                        //清空输入框
                        clearTextBox();
                        bind_reader_info();
                    }
                    else
                    {
                        lbl_note.Text = "对不起，添加失败！";
                        lbl_note.ForeColor = Color.Red;
                    }
                    conn.Close();
                }
            }
            else
            {
                MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                conn.Open();
                string str = string.Format("select borrow_limit from reader_type where RTName='{0}'", RType);
                MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
                DataTable dt = new DataTable();
                msda.Fill(dt);
                conn.Close();
                int borrow_limit = int.Parse(dt.Rows[0]["borrow_limit"].ToString());
                if (currbor > borrow_limit)
                {
                    lbl_note.Text = "最多可借" + borrow_limit + "本！";
                    lbl_note.ForeColor = Color.Red;
                    nu_curr.Focus();
                }
                else
                {
                    conn.Open();
                    MySqlCommand cmd = new MySqlCommand("updateReader", conn);
                    cmd.CommandType = CommandType.StoredProcedure;
                    //定义输入函数
                    cmd.Parameters.AddWithValue("rrid_", rrid);
                    cmd.Parameters.AddWithValue("rname_", RName);
                    cmd.Parameters.AddWithValue("rtype_", RType);
                    cmd.Parameters.AddWithValue("sex_", sex);
                    cmd.Parameters.AddWithValue("currbor_", currbor);
                    cmd.Parameters.AddWithValue("totalbor_", totalbor);
                    cmd.Parameters.AddWithValue("tel_", tel);
                    cmd.Parameters.AddWithValue("effi_", effiency);
                    cmd.Parameters.AddWithValue("state_", state);
                    cmd.Parameters.AddWithValue("violatenum_", violatenum);
                    cmd.Parameters.AddWithValue("remark_", remark);
                    //定义输出函数
                    MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                    result.Direction = ParameterDirection.Output;
                    cmd.ExecuteNonQuery();
                    if (result.Value.ToString() == "1")
                    {
                        lbl_note.Text = "恭喜你，修改成功！";
                        lbl_note.ForeColor = Color.Blue;
                        //清空输入框
                        clearTextBox();
                        bind_reader_info();
                    }
                    else
                    {
                        lbl_note.Text = "对不起，修改失败！";
                        lbl_note.ForeColor = Color.Red;
                    }
                    conn.Close();
                }
            }
        }

        private void Frm_reader_manage_Load(object sender, EventArgs e)
        {
            bind_reader_info();
            lbl_mname.Text = mname;
            cb_rtype.SelectedIndex= 0;
            cmb_state.SelectedIndex = 1;
        }

        private void lv_reader_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (lv_reader.SelectedItems.Count > 0)
            {
                ListViewItem myitem = lv_reader.SelectedItems[0];
                txt_RName.Text = myitem.SubItems[1].Text;
                cb_rtype.Text= myitem.SubItems[2].Text;
                btn_sex1.Checked = myitem.SubItems[3].Text =="男"?true:false;
                btn_sex2.Checked = !btn_sex1.Checked;
                nu_curr.Value = int.Parse(myitem.SubItems[5].Text);
                nu_total.Value = int.Parse(myitem.SubItems[6].Text);
                txt_tel.Text = myitem.SubItems[4].Text;
                dt_effi.Value = DateTime.ParseExact(myitem.SubItems[7].Text, "yyyy-MM-dd", CultureInfo.InvariantCulture);
                cmb_state.Text = myitem.SubItems[12].Text;
                nu_violate.Value = int.Parse(myitem.SubItems[11].Text);
                txt_remark.Text= myitem.SubItems[13].Text;
                lbl_status.Text = "修改";
                rrid = int.Parse(myitem.SubItems[14].Text);
            }
        }

        private void btn_cancel_Click(object sender, EventArgs e)
        {
            clearTextBox();
        }

        private void btn_del_Click(object sender, EventArgs e)
        {
            if (lv_reader.SelectedItems.Count == 0)
            {
                MessageBox.Show("请先选择要删除的读者！");
            }
            else
            {
                DialogResult dResult = MessageBox.Show("确定要删除选择的读者？", "删除提示", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (dResult == DialogResult.Yes)
                {
                    MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                    conn.Open();
                    string str = string.Format("delete from reader_info where RRID={0}", rrid);
                    MySqlCommand cmd = new MySqlCommand(str, conn);
                    int i=cmd.ExecuteNonQuery();
                    if (i>0)
                    {
                        lbl_note.Text = "恭喜你，删除成功！";
                        lbl_note.ForeColor = Color.Blue;
                        //清空输入框
                        clearTextBox();
                        bind_reader_info();
                    }
                    else
                    {
                        lbl_note.Text = "对不起，删除失败！";
                        lbl_note.ForeColor = Color.Red;
                    }
                    conn.Close();
                }
            }
        }

        private void groupBox1_Enter(object sender, EventArgs e)
        {

        }
    }
```

### 图书归还管理

```c#
public partial class Frm_return_manage : Form
    {
        private string mname,mid;
        public event myDelegate returnEvent;
        public event myDelegate logoutEvent;
        public Frm_return_manage(string mname,string mid)
        {
            this.mname = mname;
            this.mid = mid;
            InitializeComponent();
        }

        private void linkLabel1_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            returnEvent();
            this.Close();
        }

        private void linkLabel2_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            logoutEvent();
            this.Close();
        }

        private void Frm_return_manage_Load(object sender, EventArgs e)
        {
            lbl_mname.Text = mname;
            cb_head.SelectedIndex = 0;
            bind_return_info();
        }

        private void bind_return_info()
        {
            MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
            conn.Open();
            string str = "SELECT pay,RID,SID,ISBN,BName,author,EName,edit_ID,borrow_time,return_time,repayment_time,renew_num FROM fine AS a RIGHT JOIN (" +
                "select a.RRID,c.SRID,RID,SID,ISBN,BName,author,EName,edit_ID,borrow_time,return_time,repayment_time,renew_num from reader_info a,book_info b,book_store_info c,book_borrow d,book_return e ,book_edit_info f,edit_house_info g,book_date_info h " +
                "where a.RRID=d.RRID and b.BRID=c.BRID and c.SRID=d.SRID and c.SRID=e.SRID and d.RRID=e.RRID and d.SRID=e.SRID and b.BRID=f.BRID and f.PHID=g.PHID and b.BRID=h.BRID) AS b ON a.RRID=b.RRID AND a.SRID=b.SRID;";
            MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
            DataTable dt = new DataTable();
            msda.Fill(dt);
            conn.Close();
            listView1.Items.Clear();
            foreach (DataRow dr in dt.Rows)
            {
                ListViewItem myitem = new ListViewItem(dr["RID"].ToString());
                myitem.SubItems.Add(dr["SID"].ToString());
                myitem.SubItems.Add(dr["ISBN"].ToString());
                myitem.SubItems.Add(dr["BName"].ToString());
                myitem.SubItems.Add(dr["author"].ToString());
                myitem.SubItems.Add(dr["EName"].ToString());
                myitem.SubItems.Add(dr["edit_ID"].ToString());
                myitem.SubItems.Add(Convert.ToDateTime(dr["borrow_time"]).ToString("yyyy-MM-dd"));
                myitem.SubItems.Add(Convert.ToDateTime(dr["repayment_time"]).ToString("yyyy-MM-dd"));
                if (dr["return_time"].ToString()=="")
                {
                    myitem.SubItems.Add("");
                }
                else
                {
                    myitem.SubItems.Add(Convert.ToDateTime(dr["return_time"]).ToString("yyyy-MM-dd"));
                }
                if (dr["pay"].ToString() == "True")
                {
                    //已缴费
                    myitem.SubItems.Add("已缴费");
                }
                else
                {
                    if (DateTime.Compare((Convert.ToDateTime(dr["repayment_time"])), DateTime.Now) < 0)
                    {
                        myitem.SubItems.Add("已超期");
                    }
                    else
                    {
                        myitem.SubItems.Add("未超期");
                    }
                }
                myitem.SubItems.Add(dr["renew_num"].ToString());
                listView1.Items.Add(myitem);
            }
        }

        private void textBox2_TextChanged(object sender, EventArgs e)
        {

        }

        private void listView1_SelectedIndexChanged(object sender, EventArgs e)
        {
            if(listView1.SelectedItems.Count > 0)
            {
                ListViewItem myitem = listView1.SelectedItems[0];
                txt_rid.Text = myitem.SubItems[0].Text;
                if (cb_head.SelectedIndex == 0) { txt_book.Text = myitem.SubItems[2].Text; }
                else if (cb_head.SelectedIndex == 1) { txt_book.Text = myitem.SubItems[3].Text; }
                else { txt_book.Text = myitem.SubItems[1].Text; }
            }
        }

        private void cb_head_SelectedIndexChanged(object sender, EventArgs e)
        {
            if(listView1.SelectedItems.Count>0)
            {
                ListViewItem myitem = listView1.SelectedItems[0];
                if (cb_head.SelectedIndex == 0) { txt_book.Text = myitem.SubItems[3].Text; }
                else if (cb_head.SelectedIndex == 1) { txt_book.Text = myitem.SubItems[2].Text; }
                else { txt_book.Text = myitem.SubItems[1].Text; }
            }
        }

        private void button3_Click(object sender, EventArgs e)
        {
            clearTextBox();
            lbl_note.Text = string.Empty;
            bind_return_info();
        }

        private void clearTextBox()
        {
            txt_book.Text = string.Empty;
            txt_rid.Text = string.Empty;
            cb_head.SelectedIndex= 0;
        }

        private void button2_Click(object sender, EventArgs e)
        {
            string rid=txt_rid.Text.Trim();
            string isbn = "", sid = "", bname = "";
            if(cb_head.SelectedIndex == 0) { bname = txt_book.Text.Trim(); }
            else if(cb_head.SelectedIndex == 1) { isbn= txt_book.Text.Trim();}
            else { sid=txt_book.Text.Trim();}
            MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
            conn.Open();
            string str = string.Format(" SELECT pay, RID, SID, ISBN, BName, author, EName, edit_ID, borrow_time, return_time, repayment_time, renew_num FROM fine AS a " +
                "RIGHT JOIN(select a.RRID,c.SRID,RID,SID,ISBN,BName,author,EName,edit_ID,borrow_time,return_time,repayment_time,renew_num from reader_info a,book_info b,book_store_info c,book_borrow d,book_return e ,book_edit_info f,edit_house_info g,book_date_info h" +
                " where a.RRID=d.RRID and b.BRID=c.BRID and c.SRID=d.SRID and c.SRID=e.SRID and d.RRID=e.RRID and d.SRID=e.SRID and b.BRID=f.BRID and f.PHID=g.PHID and b.BRID=h.BRID and RID like '%{0}%' and BName like '%{1}%' and ISBN like '%{2}%' and SID like'%{3}%') AS b " +
                "ON a.RRID=b.RRID AND a.SRID=b.SRID;", rid, bname, isbn, sid);
            MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
            DataTable dt = new DataTable();
            msda.Fill(dt);
            conn.Close();
            listView1.Items.Clear();
            foreach (DataRow dr in dt.Rows)
            {
                ListViewItem myitem = new ListViewItem(dr["RID"].ToString());
                myitem.SubItems.Add(dr["SID"].ToString());
                myitem.SubItems.Add(dr["ISBN"].ToString());
                myitem.SubItems.Add(dr["BName"].ToString());
                myitem.SubItems.Add(dr["author"].ToString());
                myitem.SubItems.Add(dr["EName"].ToString());
                myitem.SubItems.Add(dr["edit_ID"].ToString());
                myitem.SubItems.Add(Convert.ToDateTime(dr["borrow_time"]).ToString("yyyy-MM-dd"));
                myitem.SubItems.Add(Convert.ToDateTime(dr["repayment_time"]).ToString("yyyy-MM-dd"));
                if (dr["return_time"].ToString() == "")
                {
                    myitem.SubItems.Add("");
                }
                else
                {
                    myitem.SubItems.Add(Convert.ToDateTime(dr["return_time"]).ToString("yyyy-MM-dd"));
                }
                if (dr["pay"].ToString() == "True")
                {
                    //已缴费
                    myitem.SubItems.Add("已缴费");
                }
                else
                {
                    if (DateTime.Compare((Convert.ToDateTime(dr["repayment_time"])), DateTime.Now) < 0)
                    {
                        myitem.SubItems.Add("已超期");
                    }
                    else
                    {
                        myitem.SubItems.Add("未超期");
                    }
                }
                myitem.SubItems.Add(dr["renew_num"].ToString());
                listView1.Items.Add(myitem);
            }
        }

        private void button1_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count == 0)
            {
                MessageBox.Show("请选择要归还的书籍！");
            }
            else
            {
                DialogResult dResult = MessageBox.Show("确定要归还选择的书籍？", "归还提示", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (dResult == DialogResult.Yes)
                {
                    if (listView1.SelectedItems[0].SubItems[10].Text == "已超期")
                    {
                        lbl_note.Text = "已超期！缴费后方可归还";
                        lbl_note.ForeColor = Color.Red;
                        MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                        conn.Open();
                        MySqlCommand cmd = new MySqlCommand("updateBorrow", conn);
                        cmd.CommandType = CommandType.StoredProcedure;
                        string rid = listView1.SelectedItems[0].SubItems[0].Text;
                        string sid = listView1.SelectedItems[0].SubItems[1].Text;
                        //定义输入函数
                        cmd.Parameters.AddWithValue("rid_", rid);
                        cmd.Parameters.AddWithValue("sid_", sid);
                        cmd.Parameters.AddWithValue("mid_", mid);
                        cmd.Parameters.AddWithValue("defaultType_", 0);
                        //定义输出函数
                        MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                        result.Direction = ParameterDirection.Output;
                        cmd.ExecuteNonQuery();
                        conn.Close();
                        DialogResult dResult1 = MessageBox.Show("是否前往缴费页面？", "系统提示", MessageBoxButtons.YesNo);
                        if (dResult1 == DialogResult.Yes)
                        {
                            Frm_fine_manage frm = new Frm_fine_manage(mname,mid);
                            frm.returnEvent += new myDelegate(Frm_returnEvent);
                            frm.Show();
                            this.Hide();
                        }
                    }
                    else
                    {
                        MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                        conn.Open();
                        MySqlCommand cmd = new MySqlCommand("returnBook", conn);
                        cmd.CommandType = CommandType.StoredProcedure;
                        string rid = listView1.SelectedItems[0].SubItems[0].Text;
                        string sid = listView1.SelectedItems[0].SubItems[1].Text;
                        //定义输入函数
                        cmd.Parameters.AddWithValue("rid_", rid);
                        cmd.Parameters.AddWithValue("sid_", sid);
                        cmd.Parameters.AddWithValue("mid_", mid);
                        //0--图书超期
                        cmd.Parameters.AddWithValue("defaultType_", 0);
                        //定义输出函数
                        MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                        result.Direction = ParameterDirection.Output;
                        cmd.ExecuteNonQuery();
                        if (result.Value.ToString() == "1")
                        {
                            lbl_note.Text = "恭喜你，归还成功！";
                            lbl_note.ForeColor = Color.Blue;
                            //清空输入框
                            clearTextBox();
                            bind_return_info();
                        }
                        else
                        {
                            lbl_note.Text = "对不起，归还失败！";
                            lbl_note.ForeColor = Color.Red;
                        }
                        conn.Close();
                    }
                }
            }
        }

        private void button5_Click(object sender, EventArgs e)
        {
            DialogResult dResult = MessageBox.Show("确定书籍损坏？", "系统提示", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
            if (dResult == DialogResult.Yes)
            {
                MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                conn.Open();
                MySqlCommand cmd = new MySqlCommand("updateBorrow", conn);
                cmd.CommandType = CommandType.StoredProcedure;
                string rid = listView1.SelectedItems[0].SubItems[0].Text;
                string sid = listView1.SelectedItems[0].SubItems[1].Text;
                //定义输入函数
                cmd.Parameters.AddWithValue("rid_", rid);
                cmd.Parameters.AddWithValue("sid_", sid);
                cmd.Parameters.AddWithValue("mid_", mid);
                //0--图书超期
                cmd.Parameters.AddWithValue("defaultType_", 1);
                //定义输出函数
                MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                result.Direction = ParameterDirection.Output;
                cmd.ExecuteNonQuery();
                conn.Close();
                DialogResult dResult1 = MessageBox.Show("是否前往缴费页面？", "系统提示", MessageBoxButtons.YesNo);
                if (dResult1 == DialogResult.Yes)
                {
                    Frm_fine_manage frm = new Frm_fine_manage(mname, mid);
                    frm.returnEvent += new myDelegate(Frm_returnEvent);
                    frm.Show();
                    this.Hide();
                }
            }
        }

        private void button4_Click(object sender, EventArgs e)
        {
            if(listView1.SelectedItems.Count == 0)
            {
                MessageBox.Show("请选择要续借的书籍！");
            }
            else
            {
                DialogResult dResult = MessageBox.Show("确定要续借选择的书籍？", "续借提示", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (dResult == DialogResult.Yes)
                {
                    if (listView1.SelectedItems[0].SubItems[10].Text == "已超期")
                    {
                        lbl_note.Text = "已超期！缴费后方可续借";
                        lbl_note.ForeColor = Color.Red;
                        MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                        conn.Open();
                        MySqlCommand cmd = new MySqlCommand("updateBorrow", conn);
                        cmd.CommandType = CommandType.StoredProcedure;
                        string rid = listView1.SelectedItems[0].SubItems[0].Text;
                        string sid = listView1.SelectedItems[0].SubItems[1].Text;
                        //定义输入函数
                        cmd.Parameters.AddWithValue("rid_", rid);
                        cmd.Parameters.AddWithValue("sid_", sid);
                        cmd.Parameters.AddWithValue("mid_", mid);
                        //0--图书超期
                        cmd.Parameters.AddWithValue("defaultType_", 0);
                        //定义输出函数
                        MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                        result.Direction = ParameterDirection.Output;
                        cmd.ExecuteNonQuery();
                        conn.Close();
                        DialogResult dResult1=MessageBox.Show("是否前往缴费页面？", "系统提示", MessageBoxButtons.YesNo);
                        if (dResult1 == DialogResult.Yes)
                        {
                            Frm_fine_manage frm = new Frm_fine_manage(mname, mid);
                            frm.returnEvent += new myDelegate(Frm_returnEvent);
                            frm.Show();
                            this.Hide();
                        }
                    }
                    else
                    {
                        MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                        conn.Open();
                        MySqlCommand cmd = new MySqlCommand("renewBook", conn);
                        cmd.CommandType = CommandType.StoredProcedure;
                        string rid = listView1.SelectedItems[0].SubItems[0].Text;
                        string sid = listView1.SelectedItems[0].SubItems[1].Text;
                        //定义输入函数
                        cmd.Parameters.AddWithValue("rid_", rid);
                        cmd.Parameters.AddWithValue("sid_", sid);
                        cmd.Parameters.AddWithValue("mid_", mid);
                        //定义输出函数
                        MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                        result.Direction = ParameterDirection.Output;
                        cmd.ExecuteNonQuery();
                        if (result.Value.ToString() == "1")
                        {
                            lbl_note.Text = "恭喜你，续借成功！";
                            lbl_note.ForeColor = Color.Blue;
                            //清空输入框
                            clearTextBox();
                            bind_return_info();
                        }
                        else
                        {
                            lbl_note.Text = "对不起，续借失败！";
                            lbl_note.ForeColor = Color.Red;
                        }
                        conn.Close();
                    }
                }
            }
        }

        private void Frm_returnEvent()
        {
            this.Show();
            bind_return_info();
        }
    }
```

### 图书馆藏管理

```c#
public partial class Frm_store_info : Form
    {
        protected int srid;
        private string mname;
        public event myDelegate returnEvent;
        public event myDelegate logoutEvent;
        public Frm_store_info(string mname)
        {
            this.mname = mname;
            InitializeComponent();
        }

        private void linkLabel1_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            returnEvent();
            this.Close();
        }

        private void linkLabel2_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            logoutEvent();
            this.Close();
        }

        private void Frm_store_info_Load(object sender, EventArgs e)
        {
            lbl_mname.Text = mname;
            cb_state.SelectedIndex = 1;
            bind_store_info();
        }

        protected void clearTextBox()
        {
            txt_head.Text = "";
            cb_state.Text = "";
            label1.Text = "ISBN:";
            lbl_status.Text = "添加";
            txt_head.Enabled = true;
        }

        protected void bind_store_info()
        {
            MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
            conn.Open();
            string str = "select SRID,SID,ISBN,BName,state,warehousing_date from book_store_info a,book_info b where a.BRID=b.BRID;";
            MySqlDataAdapter msda = new MySqlDataAdapter(str, conn);
            DataTable dt = new DataTable();
            msda.Fill(dt);
            conn.Close();
            listView1.Items.Clear();
            foreach (DataRow dr in dt.Rows)
            {
                ListViewItem myitem = new ListViewItem(dr["SID"].ToString());
                myitem.SubItems.Add(dr["ISBN"].ToString());
                myitem.SubItems.Add(dr["BName"].ToString());
                if (dr["state"].ToString() == "0")
                {
                    myitem.SubItems.Add("借出");
                }
                else if (dr["state"].ToString() == "1")
                {
                    myitem.SubItems.Add("在库");
                }
                else
                {
                    myitem.SubItems.Add("损坏");
                }
                myitem.SubItems.Add(Convert.ToDateTime(dr["warehousing_date"]).ToString("yyyy-MM-dd"));
                //隐藏列SRID
                myitem.SubItems.Add(dr["SRID"].ToString());
                listView1.Items.Add(myitem);
            }
        }

        private void label1_Click(object sender, EventArgs e)
        {

        }

        private void btn_save_Click(object sender, EventArgs e)
        {
            if (cb_state.Text == "")
            {
                lbl_note.Text = "请选择状态！";
                lbl_note.ForeColor = Color.Red;
                cb_state.Focus();
            }
            else if (lbl_status.Text == "添加")
            {
                if (txt_head.Text == "")
                {
                    lbl_note.Text = "请输入ISBN！";
                    lbl_note.ForeColor = Color.Red;
                    txt_head.Focus();
                }
                else
                {
                    //添加图书馆藏信息
                    MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                    conn.Open();
                    MySqlCommand cmd = new MySqlCommand("addStore", conn);
                    cmd.CommandType = CommandType.StoredProcedure;
                    //定义输入函数
                    cmd.Parameters.AddWithValue("isbn_", txt_head.Text.Trim());
                    cmd.Parameters.AddWithValue("state_", cb_state.Text.Trim()=="借出"?0:1);
                    cmd.Parameters.AddWithValue("whtime_", dt_whtime.Value.ToString("yyyy-MM-dd"));
                    //定义输出函数
                    MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                    result.Direction = ParameterDirection.Output;
                    cmd.ExecuteNonQuery();
                    if (result.Value.ToString() == "1")
                    {
                        lbl_note.Text = "恭喜你，添加成功！";
                        lbl_note.ForeColor = Color.Blue;
                        //trans.Commit();
                        //清空输入框
                        clearTextBox();
                        bind_store_info();
                    }
                    else
                    {
                        lbl_note.Text = "对不起，添加失败！";
                        lbl_note.ForeColor = Color.Red;
                    }
                    conn.Close();
                }
            }
            else
            {
                //更新图书馆藏信息
                MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                conn.Open();
                MySqlCommand cmd = new MySqlCommand("updateStore", conn);
                cmd.CommandType = CommandType.StoredProcedure;
                //定义输入函数
                cmd.Parameters.AddWithValue("srid_", srid);
                cmd.Parameters.AddWithValue("state_", cb_state.Text.Trim() == "借出" ? 0 : 1);
                cmd.Parameters.AddWithValue("whtime_", dt_whtime.Value.ToString("yyyy-MM-dd"));
                //定义输出函数
                MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                result.Direction = ParameterDirection.Output;
                cmd.ExecuteNonQuery();
                if (result.Value.ToString() == "1")
                {
                    lbl_note.Text = "恭喜你，修改成功！";
                    lbl_note.ForeColor = Color.Blue;
                    //trans.Commit();
                    //清空输入框
                    clearTextBox();
                    bind_store_info();
                }
                else
                {
                    lbl_note.Text = "对不起，修改失败！";
                    lbl_note.ForeColor = Color.Red;
                }
                conn.Close();
            }
        }

        private void listView1_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count > 0)
            {
                txt_head.Enabled = false;
                label1.Text = "图书馆藏编号：";
                ListViewItem myitem = listView1.SelectedItems[0];
                txt_head.Text = myitem.SubItems[0].Text;
                if (myitem.SubItems[3].Text == "在库")
                {
                    cb_state.SelectedIndex = 1;
                }
                else if (myitem.SubItems[3].Text == "借出")
                {
                    cb_state.SelectedIndex = 0;
                }
                else
                {
                    cb_state.SelectedIndex = 2;
                }
                dt_whtime.Value= DateTime.ParseExact(myitem.SubItems[4].Text, "yyyy-MM-dd", CultureInfo.InvariantCulture);
                lbl_status.Text = "修改";
                srid = int.Parse(myitem.SubItems[5].Text);
            }
        }

        private void btn_cancel_Click(object sender, EventArgs e)
        {
            txt_head.Enabled = true;
            clearTextBox();
            lbl_note.Text = "";
        }

        private void btn_del_Click(object sender, EventArgs e)
        {
            if (listView1.SelectedItems.Count == 0)
            {
                MessageBox.Show("请先选择要删除的书籍！");
            }
            else
            {
                DialogResult dResult = MessageBox.Show("确定要删除选择的书籍？", "删除提示", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                if (dResult == DialogResult.Yes)
                {
                    MySqlConnection conn = new MySqlConnection("Data Source=localhost;database=my_db1;UID=root;PWD=123456");
                    conn.Open();
                    MySqlCommand cmd = new MySqlCommand("deleteStore", conn);
                    cmd.CommandType = CommandType.StoredProcedure;
                    //定义输入函数
                    cmd.Parameters.AddWithValue("srid_", srid);
                    cmd.Parameters.AddWithValue("state_", cb_state.Text.Trim() == "借出" ? 0 : 1);
                    //定义输出函数
                    MySqlParameter result = cmd.Parameters.Add("result", MySqlDbType.Int64);
                    result.Direction = ParameterDirection.Output;
                    cmd.ExecuteNonQuery();
                    if (result.Value.ToString() == "1")
                    {
                        lbl_note.Text = "恭喜你，删除成功！";
                        lbl_note.ForeColor = Color.Blue;
                        //清空输入框
                        clearTextBox();
                        bind_store_info();
                    }
                    else
                    {
                        lbl_note.Text = "对不起，删除失败！";
                        lbl_note.ForeColor = Color.Red;
                    }
                    conn.Close();
                }
            }
        }
    }
```

